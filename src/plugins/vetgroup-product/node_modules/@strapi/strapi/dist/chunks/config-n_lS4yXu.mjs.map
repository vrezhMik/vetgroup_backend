{"version":3,"file":"config-n_lS4yXu.mjs","sources":["../../src/node/vite/plugins.ts","../../src/node/vite/config.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nimport { getDocumentHTML } from '../staticFiles';\nimport type { BuildContext } from '../create-build-context';\n\nconst buildFilesPlugin = (ctx: BuildContext): Plugin => {\n  const CHUNK_ID = '.strapi/client/app.js';\n\n  return {\n    name: 'strapi/server/build-files',\n    apply: 'build',\n    buildStart() {\n      this.emitFile({\n        type: 'chunk',\n        id: CHUNK_ID,\n        name: 'strapi',\n      });\n    },\n    async generateBundle(_options, outputBundle) {\n      const bundle = outputBundle;\n      const entryFile = Object.values(bundle).find(\n        (file) =>\n          file.type === 'chunk' && file.name === 'strapi' && file.facadeModuleId?.endsWith(CHUNK_ID)\n      );\n\n      if (!entryFile) {\n        throw new Error(`Failed to find entry file in bundle (${CHUNK_ID})`);\n      }\n\n      if (entryFile.type !== 'chunk') {\n        throw new Error('Entry file is not a chunk');\n      }\n\n      const entryFileName = entryFile.fileName;\n      const entryPath = [ctx.basePath.replace(/\\/+$/, ''), entryFileName].join('/');\n\n      this.emitFile({\n        type: 'asset',\n        fileName: 'index.html',\n        source: getDocumentHTML({\n          logger: ctx.logger,\n          props: {\n            entryPath,\n          },\n        }),\n      });\n    },\n  };\n};\n\nexport { buildFilesPlugin };\n","import type { InlineConfig, UserConfig } from 'vite';\nimport browserslistToEsbuild from 'browserslist-to-esbuild';\nimport react from '@vitejs/plugin-react-swc';\n\nimport { getUserConfig } from '../core/config';\nimport { loadStrapiMonorepo } from '../core/monorepo';\nimport { getMonorepoAliases } from '../core/aliases';\nimport type { BuildContext } from '../create-build-context';\nimport { buildFilesPlugin } from './plugins';\n\nconst resolveBaseConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\n  const target = browserslistToEsbuild(ctx.target);\n\n  return {\n    root: ctx.cwd,\n    base: ctx.basePath,\n    build: {\n      emptyOutDir: false, // Rely on CLI to do this\n      outDir: ctx.distDir,\n      target,\n    },\n    cacheDir: 'node_modules/.strapi/vite',\n    configFile: false,\n    define: {\n      'process.env': ctx.env,\n    },\n    envPrefix: 'STRAPI_ADMIN_',\n    optimizeDeps: {\n      include: [\n        // pre-bundle React dependencies to avoid React duplicates,\n        // even if React dependencies are not direct dependencies\n        // https://react.dev/warnings/invalid-hook-call-warning#duplicate-react\n        'react',\n        `react/jsx-runtime`,\n        'react-dom/client',\n        'styled-components',\n        'react-router-dom',\n      ],\n    },\n    resolve: {\n      // https://react.dev/warnings/invalid-hook-call-warning#duplicate-react\n      dedupe: ['react', 'react-dom', 'react-router-dom', 'styled-components'],\n    },\n    plugins: [react(), buildFilesPlugin(ctx)],\n  };\n};\n\nconst resolveProductionConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\n  const {\n    options: { minify, sourcemaps },\n  } = ctx;\n\n  const baseConfig = await resolveBaseConfig(ctx);\n\n  return {\n    ...baseConfig,\n    logLevel: 'silent',\n    mode: 'production',\n    build: {\n      ...baseConfig.build,\n      assetsDir: '',\n      minify,\n      sourcemap: sourcemaps,\n      rollupOptions: {\n        input: {\n          strapi: ctx.entry,\n        },\n      },\n    },\n  };\n};\n\nconst resolveDevelopmentConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\n  const monorepo = await loadStrapiMonorepo(ctx.cwd);\n  const baseConfig = await resolveBaseConfig(ctx);\n\n  return {\n    ...baseConfig,\n    mode: 'development',\n    resolve: {\n      ...baseConfig.resolve,\n      alias: {\n        ...baseConfig.resolve?.alias,\n        ...getMonorepoAliases({ monorepo }),\n      },\n    },\n    server: {\n      cors: false,\n      middlewareMode: true,\n      open: ctx.options.open,\n      hmr: {\n        server: ctx.options.hmrServer,\n        clientPort: ctx.options.hmrClientPort,\n      },\n    },\n    appType: 'custom',\n  };\n};\n\nconst USER_CONFIGS = ['vite.config.js', 'vite.config.mjs', 'vite.config.ts'];\n\ntype UserViteConfig = (config: UserConfig) => UserConfig;\n\nconst mergeConfigWithUserConfig = async (config: InlineConfig, ctx: BuildContext) => {\n  const userConfig = await getUserConfig<UserViteConfig>(USER_CONFIGS, ctx);\n\n  if (userConfig) {\n    return userConfig(config);\n  }\n\n  return config;\n};\n\nexport { mergeConfigWithUserConfig, resolveProductionConfig, resolveDevelopmentConfig };\n"],"names":["buildFilesPlugin","ctx","CHUNK_ID","name","apply","buildStart","emitFile","type","id","generateBundle","_options","outputBundle","bundle","entryFile","Object","values","find","file","facadeModuleId","endsWith","Error","entryFileName","fileName","entryPath","basePath","replace","join","source","getDocumentHTML","logger","props","resolveBaseConfig","target","browserslistToEsbuild","root","cwd","base","build","emptyOutDir","outDir","distDir","cacheDir","configFile","define","env","envPrefix","optimizeDeps","include","resolve","dedupe","plugins","react","resolveProductionConfig","options","minify","sourcemaps","baseConfig","logLevel","mode","assetsDir","sourcemap","rollupOptions","input","strapi","entry","resolveDevelopmentConfig","monorepo","loadStrapiMonorepo","alias","getMonorepoAliases","server","cors","middlewareMode","open","hmr","hmrServer","clientPort","hmrClientPort","appType","USER_CONFIGS","mergeConfigWithUserConfig","config","userConfig","getUserConfig"],"mappings":"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"}